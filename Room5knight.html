<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Room 5</title>
        <link rel="stylesheet" href="room5Styles.css">
    <style> 
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            padding: 20px;
            background-image: url('Room5Images/Room5.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            height: 100vh;
            margin: 0;
        }

        #game {
            width:60%;
            margin: auto;
            padding: 20px;

        }

        #output {
            font-family: 'Press Start 2P', cursive;
            line-height: 1.5;
            position: fixed;
            top: 200px;
            left: 120px;
            width: 40%;
            min-height: 150px;
            max-height: 250px;
            overflow-y: auto;
           
            padding: 20px;
            background: rgba(0, 0 , 0, 0.8);
            color: white;
            border: 2px solid red;
            font-size: 12px;
            white-space: pre-wrap;
            box-shadow: 0 0 10px red;

        }
        button {
            padding: 10px;
            margin: 5px;
            font-size: 16px;
            cursor: pointer;
        }
        #cards {
        display: none;
        justify-content: center;
        align-items: center; /* Ensure cards are vertically centered */
        gap: 20px;
        position: fixed;
        bottom: 20px; /* Distance from bottom */
        left: 50%; /* Move container to the center */
        transform: translateX(-50%); /* Adjust for actual centering */
        z-index: 100;
        padding: 10px;
        width: 80%;
        max-width: 600px;
        }

        

        .card {
            width: 100px;
            height: 150px;
            cursor: pointer;
            border: 2px solid red;
            background-color: #222;
            padding: 5px;
            box-shadow: 0 0 5px #ff0000, 0 0 10px #ff0000, 0 0 15px #ff0000; /* Red glow effect */
            transition: transform 0.2s, box-shadow 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
        }

        .card:hover {
            transform: scale(1.05);
            box-shadow: 0 0 10px #ff0000, 0 0 20px #ff0000, 0 0 30px #ff0000;
        }
        .card img {
            max-width: 150%;
            max-height: 150%;
            position: absolute;
            object-fit: contain;
            display: block;
            margin: auto;
        }
    
        #goblinContainer {
            position: fixed;
            bottom: 75px;
            right: 120px;
            display: none;
            text-align:center;
            opacity:0;
            transition: opacity 1s ease-in-out;
            z-index: 1000;
        }
        #goblinImage {
            width: 125px;
            height: auto;
            opacity: 1;
        }

        @keyframes goblinDeathGlow {
            0% {
                filter: drop-shadow( 0 0 5px red);
                opacity: 1;
            }
            50% {
                filter: drop-shadow(0 0 20px red) drop-shadow(0 0 30px red);
                opacity: 0.7;
            }
            100% {
                filter: drop-shadow(0 0 50px red) drop-shadow(0 0 70px red);
                opacity: 0;
            }
        }

        .goblin-death-glow {
            animation: goblinDeathGlow 1s ease-out forwards;
        }
       
    </style>
    </head>
    <body>
        <h1 id="gameText">Room 5</h1>
        <div id="losePopup" class="popup">
            <div class="popup-content">
                <h2>You Lose!</h2>
                <p id="gameTime">Time Played: 00:00</p>
                <p id="topScore">Top Score: 0</p>
                <button id="tryAgain">Try Again</button>
            </div>
        </div>
        <div id="winPopup" class="popup">
            <div class="popup-content">
                <h2>You Win!</h2>
                <p id="winTime">Time PLayed: 00:00</p>
                <p id="winTopScore">Top Score: 0</p>
                <button id="playAgain">Play Again</button>
                <button id="nextRoomBtn">Next Room</button>
            </div>
        </div>

        <div id="game">
           <div id="output"></div>

            <div id="knight" class="pixelart">
                <div class="knightSprite"></div>
            </div>
            
            <div id="deckContainer">
                <img id="deckCards" src="Room5Images/deckCards.png" alt="Deck of Cards">
                <span id="hoverText">Take Cards</span>
            </div>

            <div id="lampContainer">
                <img id="lamp" src="Room5Images/lamp.png" alt="Lamp">
                <span id="lampText">Analyse Room</span>
            </div>

            <div id="rightLamp" style="position: absolute; top: 350px; right:50px;">
                <img src="Room5Images/lamp.png" alt="Lamp" style="width: 100px; height:auto;">
            </div>

            <div id="doorContainer">
                <img id="door" src="Room5Images/door.png" alt="Door">
                <span id="doorText">Escape!</span>
            </div>

            <div id="knightHealthContainer">
                <div class="health-label">Knight</div>
                    <div class="health-bar">
                        <div id="knightHealth" class="health"></div>
                    </div>
                </div>
            <div id="goblinHealthContainer">
                <div class="health-label">Goblin</div>
                <div class="health-bar">
                    <div id="goblinHealth" class="health"></div>
                </div>
            </div>
            </div>
            <div id = "goblinContainer" style="display: none; text-align: center; margin-top: 20px;">
                <img id ="goblinImage" src="Room5Images/goblin.png" alt="Goblin" width="200">
            </div>
            
            <div id="choices">
               
            </div>
           
            <div id="cards">
                <div class="card" id="swordCard">
                    <img src="Room5Images/swordCard.png" alt="Sword Card">
                    
                </div>
                <div class="card" id="shieldCard">
                    <img src="Room5Images/shieldCard.png" alt="Shield Card">
                    
                </div>
                <div class="card" id="fistCard">
                    <img src="Room5Images/fistCard.png" alt="Fist Card">
                   
                </div>
                <div class="card" id="tricksterCard" style="display: none;">
                    <img src="Room5Images/tricksterCard.png" alt="Trickster Card">
                    
                </div>
            </div>
        
            <div id="keyContainer" style="display: none; position: fixed; bottom: 50px; left: 50%; transform: translateX(-50%);">
                <img id="keyImage" src="Room5Images/key.png" alt="Glowing Key">
            </div>
           
        
        <script>
             document.addEventListener("DOMContentLoaded", () => {
                let output = document.getElementById("output");
                let initialText = "You have entered room 5... where you encounter a goblin at a large table... he wants to play a game with you. It snarls, giving you three cards. What will you do?";
                typeText(output, initialText, 50, null, true);

               const knight = document.getElementById("knight");
               
               knight.style.display = "block";
                
               setTimeout(function() {
                const knightSprite = document.querySelector(".knightSprite");
                 knightSprite.style.backgroundImage = "url('Room5Images/IDLE.png')";
                 knightSprite.style.animation = 'knightIdle 1s steps(7) infinite';
                }, 3000);

                setTimeout(() => {
                    let goblin =document.getElementById("goblinContainer");
                    goblin.style.display= "block";
                    setTimeout(() => {
                        goblin.style.opacity = "1";
                    },100);
                }, 1000);
            });
            // Initialise global variables
            let gameStarted = false;
            let blackScreen;
            let player = JSON.parse(localStorage.getItem("Player"))|| { class: "Knight", health: 35, attack: 6, abilities: ["Sword Slash", "Shield Block", "Power Strike"]};
            let goblin = {health: 30, attack: 5};
            let goblinSkipsTurn = false;

            // Card deck button
            document.getElementById("deckContainer").addEventListener("click", () => {
                gameStarted = true;
                document.getElementById("deckCards").style.opacity = "0";
                setTimeout(() => {
                    document.getElementById("deckContainer").style.display = "none";
                }, 500);

                const lampContainer = document.getElementById("lampContainer");
                lampContainer.style.pointerEvents = "none"; // Disables hover and click
                document.getElementById("lamp").style.filter = "none"; // Removes any existing glow
                document.getElementById("lampText").style.display = "none"; // Ensures hover text is hidden
                
                makeChoice('Take Cards');
            });
            // Lamp button
            document.getElementById("lampContainer").addEventListener("click", () => {
                if (gameStarted) return;
                document.getElementById("lamp").style.opacity = "0";
                setTimeout(() => {
                    document.getElementById("lampContainer").style.display = "none";
                }, 500);
                makeChoice('Analyse');

            });
            document.getElementById("doorContainer").addEventListener("click", () => makeChoice('Run'));

            let typingInProgress = false;

            // Typing text animation
            function typeText(element, text, speed = 50, callback, isGameText=false) {
                if(typingInProgress) return;
                typingInProgress = true;
                element.textContent = " ";

                if(isGameText) {
                    element.classList.add('game-text');
                } else {
                    element.classList.remove('game-text');
                }

                let i = 0;
                function type() {
                    if(i < text.length) {
                        element.textContent += text.charAt(i);
                        i++
                        setTimeout(type, speed);
                    } else {
                        typingInProgress = false;
                        if(callback) callback();
                    }
                }
               
                type();
            }
           
            // User choice
            function makeChoice(choice) {
                let output= document.getElementById("output");
                if (choice === 'Take Cards') {
                   let knightHealthContainer =document.getElementById("knightHealthContainer");
                   let goblinHealthContainer =document.getElementById("goblinHealthContainer");

                   knightHealthContainer.style.display = "block";
                   goblinHealthContainer.style.display = "block";

                   document.getElementById("cards").style.display = "flex";
                   document.getElementById("tricksterCard").style.display = "none";
                   
                   updateHealthStatus();
                   startGame(); 
                   
                } else if (choice === 'Analyse') {
                    typeText(output,"\nYou decide to analyse the room...Oh Look! You found a trickster card on the floor! This card makes the goblin skip its turn.. Nice one! ");
                    document.getElementById("cards").style.display = "flex";
                   
                    let cardsContainer = document.getElementById("cards");
                    cardsContainer.style.display = "flex";
                    cardsContainer.style.justifyContent = "center";
                    document.getElementById("swordCard").style.display = "none";
                    document.getElementById("shieldCard").style.display = "none";
                    document.getElementById("fistCard").style.display = "none";

                    let tricksterCard = document.getElementById("tricksterCard");
                    tricksterCard.style.display = "flex";

                    tricksterCard.classList.add("fade-in");
                   
                    setTimeout(() => {
                        tricksterCard.classList.remove("fade-in");
                    },1000);

                   
                    tricksterCard.removeEventListener("click", tricksterCardClick);
                    tricksterCard.addEventListener("click", tricksterCardClick);

                } else if (choice === 'Run') {
                    typeText(output,"\nYou attempt to flee.. RUN!! You grab the dungeon door but it is locked!");
                }
            }

            // What happens when the trickster card is found
            function tricksterCardClick() {
                let output = document.getElementById("output");
                typeText(output, "\nYou added the Trickster card to your inventory! Now you can play the game against the goblin!");

                hasTricksterCard = true;
                document.getElementById("swordCard").style.display = "flex";
                document.getElementById("shieldCard").style.display = "flex";
                document.getElementById("fistCard").style.display = "flex";

                document.getElementById("tricksterCard").style.display = "flex";
               
                document.getElementById("choices").style.display = "none";

                let knightHealthContainer = document.getElementById("knightHealthContainer");
                let goblinHealthContainer = document.getElementById("goblinHealthContainer");
    
                knightHealthContainer.style.display = "block";
                goblinHealthContainer.style.display = "block";
    
                updateHealthStatus();
            }
            
            // Start of the game text
            function startGame(){
                let output = document.getElementById("output");
                typeText(output,"\nYou take the cards and prepare to play against the goblin! Ohhhh.. I see how this works, its like a game of rock paper scissors! The sword deals damage, the shield blocks an attack and the fists deal a weak attack. Hmm.. what card will you play?");
                    document.getElementById("choices").style.display = "none";
                    document.getElementById("cards").style.display = "flex";
            }
            // clicking on buttons
            document.getElementById("swordCard").addEventListener("click", () => playCard('Sword'));
            document.getElementById("shieldCard").addEventListener("click", () => playCard('Shield'));
            document.getElementById("fistCard").addEventListener("click", () => playCard('Fists'));
            document.getElementById("tricksterCard").addEventListener("click", () => playCard('Trickster'));
    
         
            
            // User plays card, what damage each card deals
            function playCard(card) {
                let output = document.getElementById("output");
                
                if(card === 'Sword') {
                    let damage = player.attack +3;
                    goblin.health -= damage;
                    typeText(output,`\nYou swing your Sword! It deals ${damage} damage!`, 50, () => {
                    updateHealthStatus();

                    if (goblin.health <= 0) {
                        setTimeout(() => endGame(true), 1000);
                    } else {
                        setTimeout(goblinTurn, 1000);
                    }
                });

                } else if (card === 'Shield') {
                    player.health += 5;
                    typeText(output,`\nYou raise your shield! You block and restore 5 health!`, 50, () =>{
                    updateHealthStatus();
                    setTimeout(goblinTurn, 1000);
                });

                } else if (card === 'Fists') {
                    let damage = player.attack -2;
                    goblin.health -= damage;
                    typeText(output,`\nYou throw a punch! Ouch it only deals ${damage} damage!`, 50, () => {
                        updateHealthStatus();

                    if (goblin.health <= 0) {
                        setTimeout(() => endGame(true), 1000);
                    } else {
                        setTimeout(goblinTurn, 1000);
                    }
                });
                   // If user finds trickster card 
                } else if (card === 'Trickster') {
                    goblinSkipsTurn = true;
                    typeText(output,`\nThe Trickster card causes the Goblin to skip their next turn!`, 50, () => {
                    updateHealthStatus();
                    setTimeout(goblinTurn, 1000);
              
                });

           
                }
            }
           
            
            function goblinTurn() {
                let output = document.getElementById("output");
                
                if (goblinSkipsTurn) {
                    typeText(output,"\nThe Goblin is confused by the Trickster card and skips its turn!", 50, () => {
                    goblinSkipsTurn = false;
                    updateHealthStatus();
                    });
                    return;
                }
                // Goblin's cards
                let goblinCards = ["Sword", "Shield", "Fists"];
                let goblinChoice= goblinCards[Math.floor(Math.random() * goblinCards.length)];

                if (goblinChoice === 'Sword') {
                    let damage = goblin.attack +3;
                    player.health -= damage;
                    typeText(output,`\nThe Goblin plays the **Sword Card**! It deals ${damage} damage to you!`, 50, () => {
                        updateHealthStatus();
                        if(player.health <= 0) {
                            setTimeout(() => endGame(false), 1000);
                        }
                    });
                    } else if (goblinChoice === 'Shield') {
                    goblin.health += 5;
                    typeText(output,`\nThe Goblin plays the **Shield Card**! It regains 5 health!`, 50, () =>{
                        updateHealthStatus();
                    });
                } else if (goblinChoice === 'Fists') {
                    let damage = goblin.attack -2;
                    player.health -= damage;
                    typeText(output,`\nThe Goblin plays the **Fists Card**! It deals ${damage} damage to you!`, 50, () =>{
                        updateHealthStatus();
                        if(player.health <= 0) {
                            setTimeout(() => endGame(false),1000);
                        }
                    });
                
                }

                if (player.health <= 0) {
                    endGame(false);

                }
                        
            }
            // For updating the health of the knight and the goblin during battle 
            function updateCharacterHealthBars() {
             let knightHealthBar = document.getElementById("knightCharacterHealth");
            let goblinHealthBar = document.getElementById("goblinCharacterHealth");


            let knightHealthPercentage = Math.max(0, Math.min(100, (player.health / 35) * 100));
             let goblinHealthPercentage = Math.max(0, Math.min(100, (goblin.health / 30) * 100));

             knightHealthBar.style.width = knightHealthPercentage + "%";
             goblinHealthBar.style.width = goblinHealthPercentage + "%";

   
             if (knightHealthPercentage < 50) knightHealthBar.style.background = "yellow";
             if (knightHealthPercentage < 20) knightHealthBar.style.background = "red";

             if (goblinHealthPercentage < 50) goblinHealthBar.style.background = "yellow";
             if (goblinHealthPercentage < 20) goblinHealthBar.style.background = "red";
            }

            function updateHealthStatus() {
                let knightHealthBar = document.getElementById("knightHealth");
                let goblinHealthBar = document.getElementById("goblinHealth");

                let knightHealthPercentage = Math.max(0, Math.min(100, (player.health / 35) * 100));
                let goblinHealthPercentage = Math.max(0, Math.min(100, (goblin.health / 30) * 100));

                knightHealthBar.style.width = knightHealthPercentage + "%";
                goblinHealthBar.style.width = goblinHealthPercentage + "%";

                if (knightHealthPercentage < 50) knightHealthBar.style.background = "yellow";
                if (knightHealthPercentage < 20) knightHealthBar.style.background = "red";

                if (goblinHealthPercentage < 50) goblinHealthBar.style.background = "yellow";
                if (goblinHealthPercentage < 20) goblinHealthBar.style.background = "red";
                
            
                if(!typingInProgress) {
                    let output = document.getElementById("output");
                    output.textContent += `\n[ Player Health: ${player.health} | Goblin Health: ${goblin.health} ]`;
            
                }

               
             }
             
                let gameStartTime = Date.now();
                let topScore = localStorage.getItem("topScore") || 0;
             
                // For when user wins game
            function showWinPopup() {
                let popup = document.getElementById("winPopup");

                let timeElapsed = Math.floor((Date.now() - gameStartTime)/ 1000);
                let minutes = Math.floor(timeElapsed / 60);
                let seconds = timeElapsed % 60;
                let timeString = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

                document.getElementById("winTime").innerText = `Time Played: ${timeString}`;

                if (timeElapsed > topScore) {
                    topScore = timeElapsed;
                    localStorage.setItem("topScore", topScore);
                }
                document.getElementById("winTopScore").innerText = `Top Score: ${topScore}s`;

                document.getElementById("nextRoomBtn").style.display = "inline-block";
                popup.style.display = "block";
            }
             
            
            // For when user loses game
            function showLosePopup() {
                let popup = document.getElementById("losePopup");

                let timeElapsed = Math.floor((Date.now() - gameStartTime)/ 1000);
                let minutes = Math.floor(timeElapsed / 60);
                let seconds = timeElapsed % 60;
                let timeString = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

                document.getElementById("gameTime").innerText = `Time Played: ${timeString}`;

                if (timeElapsed > topScore) {
                    topScore = timeElapsed;
                    localStorage.setItem("topScore", topScore);
                }
                document.getElementById("topScore").innerText = `Top Score: ${topScore}s`;

                popup.style.display = "block";
            }
             // end of game
            function endGame(victory) {
    let output = document.getElementById("output");
    let goblinContainer = document.getElementById("goblinContainer");
    let goblinHealthContainer = document.getElementById("goblinHealthContainer");
    let knightHealthContainer = document.getElementById("knightHealthContainer");

    if (victory) {
        goblinContainer.classList.add('goblin-death-glow');
        goblinHealthContainer.style.display = 'none';
        knightHealthContainer.style.display = 'none';
        setTimeout(() => {
            goblinContainer.style.opacity = '0';
            
            // typeText function with a callback that triggers the transition AFTER typing
            typeText(output, "The goblin has been defeated! A glowing red key appears on the floor...", 50, () => {
                // Show the key
                document.getElementById("keyContainer").style.display = "block";
                // Wait a moment before showing the win popup and transition
                setTimeout(() => {
                    
                    triggerBlackScreenTransition();
                }, 2000); // Wait 2 seconds after text finishes
            });
        });
    } else {
        goblinContainer.style.display = "none";
        goblinHealthContainer.style.display = "none";
        knightHealthContainer.style.display = "none";
        typeText(output, "\nYou have lost the card game... The Goblin cackles.", 50, () => {
            // Trigger the black screen after text finishes typing
            triggerBlackScreenTransition(() => { 
                showLosePopup();
            });
        });
    }
    document.getElementById("cards").style.display = "none";
}
            document.getElementById("playAgain").addEventListener("click", function(){
                location.reload();
            })
            document.getElementById("tryAgain").addEventListener("click", function() {
                location.reload();
            });

            document.getElementById("keyImage").addEventListener("click", function () {
                typeText(document.getElementById("output"), "\nYou picked up the glowing key! The dungeon door unlocks...");
                document.getElementById("doorContainer").classList.add("door-unlocked"); 
                // Wait a moment, then trigger the black screen transition
             setTimeout(() => {
             triggerBlackScreenTransition(() => {
            showWinPopup();
        });
    }, 5000);
});

        document.addEventListener("keydown", function(event) {
    if (event.key === "Escape") {
        triggerBlackScreenTransition();
    }
});

function triggerBlackScreenTransition(callback) {
    blackScreen.style.opacity = "1"; // Fade in to black
    setTimeout(() => {
        // Execute callback if provided
        if (callback) callback();
     
      
    }, 1000); // Wait for the transition to complete
}

// Initialize the black screen when the document loads
document.addEventListener("DOMContentLoaded", function() {
    // Create the black screen element
    blackScreen = document.createElement("div");
    blackScreen.style.position = "fixed";
    blackScreen.style.top = "0";
    blackScreen.style.left = "0";
    blackScreen.style.width = "100%";
    blackScreen.style.height = "100%";
    blackScreen.style.backgroundColor = "black";
    blackScreen.style.opacity = "0";
    blackScreen.style.pointerEvents = "none";
    blackScreen.style.transition = "opacity 1s ease-in-out";
    document.body.appendChild(blackScreen);
});

    // Listen for dungeon door click
    let door = document.getElementById("doorContainer"); 
    if (door) {
        door.addEventListener("click", function () {
            triggerBlackScreenTransition();
            showLosePopup();
        });
    }


        document.getElementById("nextRoomBtn").addEventListener("click", function(){
            window.location.href = "room6.html";
        });




        </script>
    
  
   
    </body>
</html>